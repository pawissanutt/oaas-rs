= OaaS-RS: Object-as-a-Service in Rust
:toc:
:toc-placement: preamble
:toclevels: 2

// Need some preamble to get TOC:
{empty}

== Introduction
A Rust reimplementation of https://github.com/hpcclab/OaaS[Oparaca] â€” an Object-as-a-Service platform with separate control and data planes. Control plane manages class/function deployments via Kubernetes; data plane handles invocations, routing, and stateful object storage.

== Quick Start

=== Prerequisites 
- Rust toolchain (https://www.rust-lang.org/tools/install)
- `protobuf-compiler`, `libssl-dev`
- Container runtime (Docker/Podman)
- kubectl, kind, just (for k8s deployment)

=== Build
[source,bash]
----
# Build all binaries
cargo build -r

# Build container images
docker compose -f docker-compose.build.yml build

# Or use just recipes
just build release
----

== Architecture

=== Planes
- **Control Plane**: Package Manager (PM) + Class Runtime Manager (CRM). PM exposes REST API for package/deployment CRUD; talks to CRM(s) via gRPC. CRM is a Kubernetes controller managing `ClassRuntime` CRDs and applying function + ODGM resources.
- **Data Plane**: Gateway (REST/gRPC ingress), Router (Zenoh messaging), ODGM (stateful object grid), and function runtimes (user code).

[mermaid]
ifdef::env-github[[source,mermaid]]
....
graph TB
    subgraph CP["Control Plane"]
        PM["ğŸ“¦ PM<br/>Package Manager<br/>REST API"]
        CRM["âš™ï¸ CRM<br/>Class Runtime Manager<br/>K8s Controller"]
    end
    
    subgraph DP["Data Plane"]
        GW["ğŸšª Gateway<br/>REST/gRPC Ingress"]
        RT["ğŸ”€ Router<br/>Zenoh Messaging"]
        ODGM["ğŸ—„ï¸ ODGM<br/>Object Data Grid"]
        FN["ğŸ”§ Function<br/>Runtimes"]
    end
    
    subgraph K8S["Kubernetes"]
        CRD["ClassRuntime CRD"]
        RES["Deployments<br/>Services"]
    end
    
    Client["ğŸ‘¤ Client"] -->|REST| PM
    Client -->|REST/gRPC| GW
    PM -->|gRPC| CRM
    CRM <-->|Server-Side Apply| K8S
    GW --> RT
    RT -->|Zenoh| ODGM
    RT -->|Zenoh| FN
    FN -.->|Discover| ODGM
    
    classDef cp fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef dp fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef k8s fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    
    class PM,CRM cp
    class GW,RT,ODGM,FN dp
    class CRD,RES k8s
....

=== Key Components

|===
|Component |Location |Role

|PM
|`control-plane/oprc-pm`
|Package registry, multi-cluster orchestration

|CRM
|`control-plane/oprc-crm`
|Kubernetes controller, ClassRuntime CRD, NFR enforcement

|ODGM
|`data-plane/oprc-odgm`
|Object Data Grid with Raft consensus, separate deployment per class

|Gateway
|`data-plane/oprc-gateway`
|Stateless ingress, REST/gRPC â†’ Zenoh translation

|Router
|`data-plane/oprc-router`
|Zenoh-based pub/sub and RPC routing

|Commons
|`commons/*`
|Shared libs: models, gRPC protos, Zenoh config, storage abstractions
|===

=== Communication
- External: REST (PM, Gateway) and gRPC (PM â†” CRM, Gateway)
- Internal: Zenoh pub/sub + `flare-zrpc` (data plane)
- Kubernetes: kube-rs with server-side apply (CRM)

=== Typical Flow
1. **Deploy**: Client â†’ PM (REST) â†’ CRM (gRPC) â†’ upsert ClassRuntime CRD â†’ reconcile â†’ apply function + ODGM resources
2. **Invoke**: Client â†’ Gateway (REST/gRPC) â†’ Router (Zenoh) â†’ Function runtime or ODGM
3. **Status**: Client â†’ PM â†’ CRM â†’ read ClassRuntime conditions
4. **Delete**: Client â†’ PM â†’ CRM â†’ mark CRD for deletion â†’ cleanup resources

== Development

=== Run Locally
[source,bash]
----
# Start dev environment (docker-compose)
just compose-dev

# Or run individual services
RUST_LOG=debug cargo run -p oprc-crm
RUST_LOG=debug cargo run -p oprc-pm
RUST_LOG=debug cargo run -p oprc-odgm
----

=== Test
[source,bash]
----
# All tests
cargo test --workspace

# Control plane tests
just -f control-plane/justfile all-it

# Specific service
cargo test -p oprc-crm
cargo test -p oprc-pm
cargo test -p oprc-odgm
----

=== Deploy to Kubernetes
[source,bash]
----
# Deploy all components
./k8s/charts/deploy.sh deploy

# Or with just
just deploy

# Undeploy
just undeploy
----

== Configuration
Services use env-first config via `envconfig`. Common patterns:

- **Logging**: `RUST_LOG=debug,openraft=info,zenoh=info`
- **Zenoh**: `OPRC_ZENOH_PEERS`, `OPRC_ZENOH_PORT`, `OPRC_ZENOH_MODE`
- **CRM**: `HTTP_PORT`, `GRPC_PORT`, `OPRC_CRM_FEATURES_*`
- **PM**: `SERVER_PORT`, `CRM_DEFAULT_URL`, `CRM_CLUSTERS_JSON`
- **ODGM**: `ODGM_HTTP_PORT`, `ODGM_NODE_ID`, `ODGM_COLLECTION`

See component READMEs for details.

== Project Structure
[source]
----
commons/              # Shared libraries
â”œâ”€â”€ oprc-grpc/       # Protobuf definitions & clients
â”œâ”€â”€ oprc-models/     # Domain models
â”œâ”€â”€ oprc-zenoh/      # Zenoh config helpers
â”œâ”€â”€ oprc-dp-storage/ # Data plane storage (memory, redb, fjall, rocksdb)
â””â”€â”€ oprc-cp-storage/ # Control plane storage (memory, etcd)

control-plane/
â”œâ”€â”€ oprc-pm/         # Package Manager (REST API)
â””â”€â”€ oprc-crm/        # Class Runtime Manager (K8s controller)

data-plane/
â”œâ”€â”€ oprc-gateway/    # REST/gRPC ingress
â”œâ”€â”€ oprc-router/     # Zenoh routing
â”œâ”€â”€ oprc-odgm/       # Object Data Grid Manager
â””â”€â”€ oprc-dev/        # Development utilities

tools/
â””â”€â”€ oprc-cli/        # CLI tool for OaaS operations
----

== References
- link:control-plane/oprc-crm/README.md[CRM Documentation]
- link:control-plane/oprc-pm/README.md[PM Documentation]  
- link:data-plane/oprc-odgm/README.adoc[ODGM Documentation]
- link:data-plane/oprc-gateway/README.md[Gateway Documentation]
- Original Java implementation: https://github.com/hpcclab/OaaS
