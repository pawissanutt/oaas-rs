syntax = "proto3";
package oaas.deployment;

import "common.proto";

service DeploymentService {
  rpc Deploy(DeployRequest) returns (DeployResponse);
  rpc GetDeploymentStatus(GetDeploymentStatusRequest) returns (GetDeploymentStatusResponse);
  rpc DeleteDeployment(DeleteDeploymentRequest) returns (DeleteDeploymentResponse);
  rpc ListDeploymentRecords(ListDeploymentRecordsRequest) returns (ListDeploymentRecordsResponse);
  rpc GetDeploymentRecord(GetDeploymentRecordRequest) returns (GetDeploymentRecordResponse);
}

// A coarse summary of a deployment's state for list views and quick filtering.
enum SummarizedStatus {
  SUMMARY_UNKNOWN = 0;
  RUNNING = 1;
  PROGRESSING = 2;
  DEGRADED = 3;
  ERROR = 4;
  NOT_FOUND = 5;
}

message FunctionDeploymentSpec {
  string function_key = 1;
  uint32 replicas = 2;
  oaas.common.ResourceRequirements resource_requirements = 3;
  // Optional container image (propagated into DeploymentRecordSpec.function.image)
  string image = 4;
}

// Reference to a child infrastructure/resource object created for a deployment
// (e.g., Deployment, Service, HPA, Monitor, etc.). Names are cluster-local.
message ResourceReference {
  string kind = 1;
  string name = 2;
  // Optional namespace (for namespaced resources)
  optional string namespace = 3;
  // Optional UID for stronger correlation/auditing
  optional string uid = 4;
}

message OClassDeployment {
  string key = 1;
  string package_name = 2;
  string class_key = 3;
  string target_env = 4;
  repeated string target_clusters = 5;
  oaas.common.NfrRequirements nfr_requirements = 6;
  repeated FunctionDeploymentSpec functions = 7;
  oaas.common.Timestamp created_at = 8;
  // Summary field (for list views): optional coarse status.
  optional SummarizedStatus summarized_status = 9;
  // Tag 10 was used temporarily; reserve to avoid reuse.
  reserved 10;
  // Child resource references (subset; may expand over time)
  repeated ResourceReference resource_refs = 11;
}

message DeploymentUnit {
  string id = 1;
  string package_name = 2;
  string class_key = 3;
  string target_cluster = 4;
  repeated FunctionDeploymentSpec functions = 5;
  string target_env = 6;
  oaas.common.NfrRequirements nfr_requirements = 7;
  oaas.common.Timestamp created_at = 8;
}

message DeployRequest {
  DeploymentUnit deployment_unit = 1;
}

message DeployResponse {
  oaas.common.StatusCode status = 1;
  string deployment_id = 2;
  optional string message = 3;
}

message GetDeploymentStatusRequest {
  string deployment_id = 1;
}

message GetDeploymentStatusResponse {
  oaas.common.StatusCode status = 1;
  optional OClassDeployment deployment = 2;
  optional string message = 3;
  // Direct status-level resource refs (may include transient objects not embedded in deployment summary)
  repeated ResourceReference status_resource_refs = 4;
}

message DeleteDeploymentRequest {
  string deployment_id = 1;
}

message DeleteDeploymentResponse {
  oaas.common.StatusCode status = 1;
  optional string message = 2;
}

// Optional CRM-side record browsing APIs
message ListDeploymentRecordsRequest {
  // Optional filters
  optional string package_name = 1;
  optional string class_key = 2;
  optional string target_env = 3;
  optional string status = 4; // provider-defined summary
  // Pagination
  optional uint32 limit = 10;
  optional uint32 offset = 11;
}

message ListDeploymentRecordsResponse {
  repeated OClassDeployment items = 1;
}

message GetDeploymentRecordRequest {
  string deployment_id = 1;
}

message GetDeploymentRecordResponse {
  optional OClassDeployment deployment = 1;
}
