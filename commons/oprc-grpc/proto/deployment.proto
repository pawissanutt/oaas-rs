syntax = "proto3";
package oaas.deployment;

import "common.proto";

service DeploymentService {
  rpc Deploy(DeployRequest) returns (DeployResponse);
  rpc GetDeploymentStatus(GetDeploymentStatusRequest) returns (GetDeploymentStatusResponse);
  rpc DeleteDeployment(DeleteDeploymentRequest) returns (DeleteDeploymentResponse);
  rpc ListDeploymentRecords(ListDeploymentRecordsRequest) returns (ListDeploymentRecordsResponse);
  rpc GetDeploymentRecord(GetDeploymentRecordRequest) returns (GetDeploymentRecordResponse);
}

// A coarse summary of a deployment's state for list views and quick filtering.
enum SummarizedStatus {
  SUMMARY_UNKNOWN = 0;
  RUNNING = 1;
  PROGRESSING = 2;
  DEGRADED = 3;
  ERROR = 4;
  NOT_FOUND = 5;
}

message FunctionDeploymentSpec {
  string function_key = 1;
  // reserved field numbers 2 and 4 (previously replicas and image)
  reserved 2, 4;
  // Optional human-readable description
  optional string description = 5;
  // Optional available location/environment name (e.g., "edge", "cloud")
  optional string available_location = 6;
  // Per-function non-functional requirements
  optional oaas.common.NfrRequirements nfr_requirements = 7;
  // Provisioning configuration (image, ports, scaling, resources)
  optional oaas.common.ProvisionConfig provision_config = 8;
  // Arbitrary config key/value pairs (injected as ENV)
  map<string, string> config = 9;
}

// Reference to a child infrastructure/resource object created for a deployment
// (e.g., Deployment, Service, HPA, Monitor, etc.). Names are cluster-local.
message ResourceReference {
  string kind = 1;
  string name = 2;
  // Optional namespace (for namespaced resources)
  optional string namespace = 3;
  // Optional UID for stronger correlation/auditing
  optional string uid = 4;
}


message DeploymentUnit {
  string id = 1;
  string package_name = 2;
  string class_key = 3;
  string target_cluster = 4;
  repeated FunctionDeploymentSpec functions = 5;
  string target_env = 6;
  // reserved 7 (previously deployment-level NfrRequirements; now per-function)
  reserved 7;
  oaas.common.Timestamp created_at = 8;
  // Optional ODGM configuration hints to be used by CRM when rendering collections and routing
  OdgmConfig odgm_config = 9;
}

message DeployRequest {
  DeploymentUnit deployment_unit = 1;
}

message DeployResponse {
  oaas.common.StatusCode status = 1;
  string deployment_id = 2;
  optional string message = 3;
}

message GetDeploymentStatusRequest {
  string deployment_id = 1;
}

message GetDeploymentStatusResponse {
  oaas.common.StatusCode status = 1;
  optional DeploymentUnit deployment = 2;
  optional string message = 3;
  // Direct status-level resource refs (may include transient objects not embedded in deployment summary)
  repeated ResourceReference status_resource_refs = 4;
}

message DeleteDeploymentRequest {
  string deployment_id = 1;
}

message DeleteDeploymentResponse {
  oaas.common.StatusCode status = 1;
  optional string message = 2;
}

// Optional CRM-side record browsing APIs
message ListDeploymentRecordsRequest {
  // Optional filters
  optional string package_name = 1;
  optional string class_key = 2;
  optional string target_env = 3;
  optional string status = 4; // provider-defined summary
  // Pagination
  optional uint32 limit = 10;
  optional uint32 offset = 11;
}

message ListDeploymentRecordsResponse {
  repeated DeploymentUnit items = 1;
}

message GetDeploymentRecordRequest {
  string deployment_id = 1;
}

message GetDeploymentRecordResponse {
  optional DeploymentUnit deployment = 1;
}

// ODGM configuration embedded in DeploymentUnit
message OdgmConfig {
  repeated string collections = 1;
  optional uint32 partition_count = 2;
  optional uint32 replica_count = 3;
  optional string shard_type = 4;
  InvocationRoutes invocations = 5;
  map<string, string> options = 6;
}

message InvocationRoutes {
  map<string, FunctionRoute> fn_routes = 1;
  repeated string disabled_fn = 2;
}

message FunctionRoute {
  string url = 1;
  optional bool stateless = 2;
  optional bool standby = 3;
  repeated uint64 active_group = 4;
}
