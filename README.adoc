= OaaS-RS: Object-as-a-Service in Rust
:toc:
:toc-placement: preamble
:toclevels: 2

// Need some preamble to get TOC:
{empty}

== Introduction
A Rust reimplementation of https://github.com/hpcclab/OaaS[Oparaca] ‚Äî an Object-as-a-Service platform with separate control and data planes. Control plane manages class/function deployments via Kubernetes; data plane handles invocations, routing, and stateful object storage.

== Quick Start

=== Prerequisites 
- Rust toolchain (https://www.rust-lang.org/tools/install)
- `protobuf-compiler`, `libssl-dev`
- Container runtime (Docker/Podman)
- kubectl, kind, just (for k8s deployment)

=== Build
[source,bash]
----
# Build all binaries
cargo build -r

# Build container images
docker compose -f docker-compose.build.yml build

# Or use just recipes
just build release
----

== Architecture

=== Planes
- **Control Plane**: Package Manager (PM) + Class Runtime Manager (CRM). PM exposes REST API for package/deployment CRUD; talks to CRM(s) via gRPC. CRM is a Kubernetes controller managing `ClassRuntime` CRDs and applying function + ODGM resources.
- **Data Plane**: Gateway (REST/gRPC ingress), Router (Zenoh messaging), ODGM (stateful object grid), and function runtimes (user code).

[mermaid]
ifdef::env-github[[source,mermaid]]
....
graph TB
    subgraph CP["Control Plane"]
        PM["üì¶ PM<br/>Package Manager<br/>REST API"]
        CRM["‚öôÔ∏è CRM<br/>Class Runtime Manager<br/>K8s Controller"]
    end
    
    subgraph DP["Data Plane"]
        GW["üö™ Gateway<br/>REST/gRPC Ingress"]
        RT["üîÄ Router<br/>Zenoh Messaging"]
        ODGM["üóÑÔ∏è ODGM<br/>Object Data Grid"]
        FN["üîß Function<br/>Runtimes"]
    end
    
    subgraph K8S["Kubernetes"]
        CRD["ClassRuntime CRD"]
        RES["Deployments<br/>Services"]
    end
    
    Client["üë§ Client"] -->|REST| PM
    Client -->|REST/gRPC| GW
    PM -->|gRPC| CRM
    CRM <-->|Server-Side Apply| K8S
    GW --> RT
    RT -->|Zenoh| ODGM
    RT -->|Zenoh| FN
    FN -.->|Discover| ODGM
    
    classDef cp fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef dp fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef k8s fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    
    class PM,CRM cp
    class GW,RT,ODGM,FN dp
    class CRD,RES k8s
....

=== Key Components

|===
|Component |Location |Role

|PM
|`control-plane/oprc-pm`
|Package registry, multi-cluster orchestration

|CRM
|`control-plane/oprc-crm`
|Kubernetes controller, ClassRuntime CRD, NFR enforcement

|ODGM
|`data-plane/oprc-odgm`
|Object Data Grid with Raft consensus, separate deployment per class

|Gateway
|`data-plane/oprc-gateway`
|Stateless ingress, REST/gRPC ‚Üí Zenoh translation

|Router
|`data-plane/oprc-router`
|Zenoh-based pub/sub and RPC routing

|Commons
|`commons/*`
|Shared libs: models, gRPC protos, Zenoh config, storage abstractions
|===

=== String Object IDs & String Entry Keys (Preview ‚Üí GA)

String-based object identifiers and string entry keys provide human-readable addressing and richer per-entry semantics alongside existing numeric IDs.

Key points:

* Enablement: Controlled by ODGM env flags `ODGM_ENABLE_STRING_IDS` and `ODGM_ENABLE_STRING_ENTRY_KEYS` (both default true). Set to `false` to simulate pre-feature clusters or for rollback.
* Normalization: Server lowercases all provided `object_id_str`; allowed charset: `[a-z0-9._:-]`; max length configurable via `ODGM_MAX_STRING_ID_LEN` (default 160).
* Semantics:
** Numeric Set = upsert (create or replace)
** String Set = create-only (duplicate returns AlreadyExists)
** Merge preserves existing entries and adds/updates provided ones
* Entries:
** Numeric entry keys remain `u32` ‚Üí `ValData`
** String entry keys stored in parallel map (`entries_str`) with identical value type
* Events / Triggers: String keys participate in create / update / delete trigger fanout just like numeric keys.
* Capabilities: Query via `oprc-cli capabilities` for runtime-advertised support.
* CLI Usage Examples:
** Create string-id object: `oprc-cli object setstr --cls-id users 0 --object-id-str user-42 -s name=alice -s role=admin`
** Get single string field: `oprc-cli object getstr --cls-id users 0 --object-id-str user-42 --key-str name`
** Numeric coexistence: Both numeric and string objects may exist in same collection and partition.
* Rollback: Disable flags; existing string objects remain addressable internally but new creates will return UNIMPLEMENTED.

Metrics:

* `odgm_object_set_total{variant}` and `odgm_get_total{variant}` differentiate numeric vs string
* `odgm_entry_mutations_total{key_variant}` increments by key type (numeric|string)
* Gateway attempts / rejections counters: `gateway_string_id_attempt_total`, `gateway_string_id_rejected_total`

Planned:

* Adoption tracking and default flip to string IDs once usage threshold reached.

=== Communication
- External: REST (PM, Gateway) and gRPC (PM ‚Üî CRM, Gateway)
- Internal: Zenoh pub/sub + `flare-zrpc` (data plane)
- Kubernetes: kube-rs with server-side apply (CRM)

=== Typical Flow
1. **Deploy**: Client ‚Üí PM (REST) ‚Üí CRM (gRPC) ‚Üí upsert ClassRuntime CRD ‚Üí reconcile ‚Üí apply function + ODGM resources
2. **Invoke**: Client ‚Üí Gateway (REST/gRPC) ‚Üí Router (Zenoh) ‚Üí Function runtime or ODGM
3. **Status**: Client ‚Üí PM ‚Üí CRM ‚Üí read ClassRuntime conditions
4. **Delete**: Client ‚Üí PM ‚Üí CRM ‚Üí mark CRD for deletion ‚Üí cleanup resources

== Development

=== Run Locally
[source,bash]
----
# Start dev environment (docker-compose)
just compose-dev

# Or run individual services
RUST_LOG=debug cargo run -p oprc-crm
RUST_LOG=debug cargo run -p oprc-pm
RUST_LOG=debug cargo run -p oprc-odgm
----

=== Test
[source,bash]
----
# All tests
cargo test --workspace

# Control plane tests
just -f control-plane/justfile all-it

# Specific service
cargo test -p oprc-crm
cargo test -p oprc-pm
cargo test -p oprc-odgm
----

=== Deploy to Kubernetes
[source,bash]
----
# Deploy all components
./k8s/charts/deploy.sh deploy

# Or with just
just deploy

# Undeploy
just undeploy
----

== Configuration
Services use env-first config via `envconfig`. Common patterns:

- **Logging**: `RUST_LOG=debug,openraft=info,zenoh=info`
- **Zenoh**: `OPRC_ZENOH_PEERS`, `OPRC_ZENOH_PORT`, `OPRC_ZENOH_MODE`
- **CRM**: `HTTP_PORT`, `GRPC_PORT`, `OPRC_CRM_FEATURES_*`
- **PM**: `SERVER_PORT`, `CRM_DEFAULT_URL`, `CRM_CLUSTERS_JSON`
- **ODGM**: `ODGM_HTTP_PORT`, `ODGM_NODE_ID`, `ODGM_COLLECTION`

See component READMEs for details.

== Project Structure
[source]
----
commons/              # Shared libraries
‚îú‚îÄ‚îÄ oprc-grpc/       # Protobuf definitions & clients
‚îú‚îÄ‚îÄ oprc-models/     # Domain models
‚îú‚îÄ‚îÄ oprc-zenoh/      # Zenoh config helpers
‚îú‚îÄ‚îÄ oprc-dp-storage/ # Data plane storage (memory, redb, fjall, rocksdb)
‚îî‚îÄ‚îÄ oprc-cp-storage/ # Control plane storage (memory, etcd)

control-plane/
‚îú‚îÄ‚îÄ oprc-pm/         # Package Manager (REST API)
‚îî‚îÄ‚îÄ oprc-crm/        # Class Runtime Manager (K8s controller)

data-plane/
‚îú‚îÄ‚îÄ oprc-gateway/    # REST/gRPC ingress
‚îú‚îÄ‚îÄ oprc-router/     # Zenoh routing
‚îú‚îÄ‚îÄ oprc-odgm/       # Object Data Grid Manager
‚îî‚îÄ‚îÄ oprc-dev/        # Development utilities

tools/
‚îî‚îÄ‚îÄ oprc-cli/        # CLI tool for OaaS operations
----

== References
- link:control-plane/oprc-crm/README.md[CRM Documentation]
- link:control-plane/oprc-pm/README.md[PM Documentation]  
- link:data-plane/oprc-odgm/README.adoc[ODGM Documentation]
- link:data-plane/oprc-gateway/README.md[Gateway Documentation]
- Original Java implementation: https://github.com/hpcclab/OaaS
